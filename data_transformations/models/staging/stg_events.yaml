version: 2

models:
  - name: stg_events
    description: "Cleansed and type-casted event data from the raw source. One row per event."
    columns:
      - name: event_id
        description: "The unique identifier for the event."
        tests:
          - unique
          - not_null

      - name: event_type
        description: "The type of event that occurred."
        tests:
          - accepted_values:
              arguments: 
                values: ['page_view', 'add_to_cart', 'checkout', 'product_view','remove_from_cart']

      - name: event_at_ts
        description: "The timestamp when the event occurred."
        tests:
          - not_null

      # - name: user_id
      #   description: "The user who performed the event."
      #   tests:
      #     - not_null:
      #       severity: warn

      # - name: product_id
      #   description: "The product ID associated with the event. Can be NULL or an 'orphan' ID."
      #   tests:
      #     - not_null:
      #         where: "event_type in ('add_to_cart', 'remove_from_cart', 'product_view')"
      #         severity: warn
      - name: user_id
        description: "The user who performed the event. Can be NULL for 'guest' users."
        tests:
          # --- REMOVED: 'not_null' test is no longer valid. ---
          # We now allow NULL user_IDs for guest sessions.
          - not_null:
              arguments:
                severity: error


      - name: product_id
        description: "The product ID associated with the event. Can be NULL or an 'orphan' ID."
        tests:
          # We test for referential integrity in the mart layer, not here.
          - not_null:
              arguments:
                where: "event_type not in ('page_view')"
                severity: error 
